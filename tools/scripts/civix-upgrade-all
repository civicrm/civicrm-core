#!/bin/bash
{

## Optional: Override the reference to civix.
CIVIX=${CIVIX:-civix}

###############################################################################
## Helpers

fatal() {
  echo >&2 "$@"
  exit 1
}

# Function to process directories recursively
process_directory() {
    local dir="$1"

    # Change to the current directory
    cd "$dir" || exit 1

    # Check if info.xml exists in current directory
    if [ -f "info.xml" ]; then
        echo
        echo "Executing 'civix upgrade' in $dir"
        echo
        "$CIVIX" upgrade
    fi

    # Iterate through subdirectories
    for subdir in */; do
        if [ -d "$subdir" ]; then
            # Process subdirectory recursively
            (process_directory "$(pwd)/$subdir")
        fi
    done

    # Return to parent directory
    cd ..
}

###############################################################################
## Main

# Check if directory path argument is provided
if [ $# -ne 1 ]; then
    fatal "Usage: $0 <directory_path>"
fi

# Check if the provided path exists and is a directory
if [ ! -d "$1" ]; then
    fatal "Error: '$1' is not a valid directory"
fi

# Start processing from the provided directory
process_directory "$1"

exit
}
