<?php

/**
 * Class CRM_Core_CodeGen_FreshnessTest
 * @group headless
 *
 * Ensure that any files which are autogenerated AND which are
 * committed to git are ALSO up-to-date.
 */
class CRM_Core_CodeGen_FreshnessTest extends CiviUnitTestCase {

  public function testDAOs() {
    $path = rtrim($GLOBALS['civicrm_root'], '/');

    $genCode = new CRM_Core_CodeGen_Main(
      $path . '/CRM/Core/DAO/', // $CoreDAOCodePath
      $path . '/sql/', // $sqlCodePath
      $path . '/', // $phpCodePath
      $path . '/templates/', // $tplCodePath
      array(
        // smarty plugin dirs
        $path . '/packages/Smarty/plugins',
        $path . '/CRM/Core/Smarty/plugins',
      ),
      CIVICRM_UF, // cms
      NULL, // db version
      $path . '/xml/schema/Schema.xml', // schema file
      NULL  // path to digest file
    );

    $tasks = $genCode->getTasks();
    $names = array();
    foreach ($tasks as $task) {
      if ($task instanceof CRM_Core_CodeGen_DAO) {
        $names[] = $task->name;
        $this->assertFalse($task->needsUpdate(),
          "Expect DAO for {$task->name} is up-to-date.");
      }
    }

    // Pick some example to ensure the loop ran with real values.
    $this->assertTrue(in_array('civicrm_contact', $names),
      'Expect the list of tables to include civicrm_contact');
  }

}
