<?xml version="1.0" encoding="iso-8859-1" ?>

<table>
  <base>CRM/Contact</base>
  <class>RelationshipVortex</class>
  <name>civicrm_relationship_vtx</name>
  <comment>The vortex permutes information from the relationship table to facilitate querying. Every relationship is mapped to multiple records in the vortex. Joins should begin on the near side and extract info from the far side.</comment>
  <add>5.29</add>
  <log>false</log>
  <icon>fa-handshake-o</icon>

  <field>
    <name>id</name>
    <type>int unsigned</type>
    <title>Relationship Vortex ID</title>
    <required>true</required>
    <comment>Relationship Vortex ID</comment>
    <add>5.29</add>
  </field>
  <primaryKey>
    <name>id</name>
    <autoincrement>true</autoincrement>
  </primaryKey>

  <field>
    <name>relationship_id</name>
    <type>int unsigned</type>
    <title>Relationship</title>
    <required>true</required>
    <comment>id of the relationship (FK to civicrm_relationship.id)</comment>
    <add>5.29</add>
  </field>
  <foreignKey>
    <name>relationship_id</name>
    <table>civicrm_relationship</table>
    <key>id</key>
    <add>5.29</add>
    <onDelete>CASCADE</onDelete>
  </foreignKey>

  <field>
    <name>relationship_type_id</name>
    <type>int unsigned</type>
    <title>Relationship Type</title>
    <required>true</required>
    <comment>id of the relationship type</comment>
    <add>5.29</add>
  </field>
  <foreignKey>
    <name>relationship_type_id</name>
    <table>civicrm_relationship_type</table>
    <key>id</key>
    <add>5.29</add>
    <onDelete>CASCADE</onDelete>
  </foreignKey>

  <field>
    <name>orientation</name>
    <type>char</type>
    <length>3</length>
    <title>Orientation (a_b or b_a)</title>
    <required>true</required>
    <default></default>
    <comment>The vortex record is a permutation of the original relationship record. The orientation indicates whether it is forward (a_b) or reverse (b_a) relationship.</comment>
    <add>5.29</add>
  </field>

  <field>
    <name>near_contact_id</name>
    <type>int unsigned</type>
    <title>Contact ID (Near side)</title>
    <required>true</required>
    <comment>id of the first contact</comment>
    <add>5.29</add>
  </field>
  <foreignKey>
    <name>near_contact_id</name>
    <table>civicrm_contact</table>
    <key>id</key>
    <add>5.29</add>
    <onDelete>CASCADE</onDelete>
  </foreignKey>

  <field>
    <name>relation</name>
    <type>varchar</type>
    <title>Relationship Name (Near side)</title>
    <length>64</length>
    <comment>name for relationship of near_contact to far_contact.</comment>
    <add>5.29</add>
  </field>

  <field>
    <name>far_contact_id</name>
    <type>int unsigned</type>
    <title>Contact ID (Far side)</title>
    <required>true</required>
    <comment>id of the second contact</comment>
    <add>5.29</add>
    <html>
      <type>EntityRef</type>
    </html>
  </field>
  <foreignKey>
    <name>far_contact_id</name>
    <table>civicrm_contact</table>
    <key>id</key>
    <add>5.29</add>
    <onDelete>CASCADE</onDelete>
  </foreignKey>

  <index>
    <name>UI_relationship</name>
    <fieldName>relationship_id</fieldName>
    <fieldName>orientation</fieldName>
    <unique>true</unique>
    <add>5.29</add>
  </index>
  <index>
    <!-- Ex: select ... from contact inner join vtx on contact.id=vtx.near_contact_id and relation = 'foo' -->
    <name>index_nearid_relation</name>
    <fieldName>near_contact_id</fieldName>
    <fieldName>relation</fieldName>
    <add>5.29</add>
  </index>
  <index>
    <!-- Ex: select relation, count(*) from vtx group by relation -->
    <name>index_relation</name>
    <fieldName>relation</fieldName>
    <add>5.29</add>
  </index>
</table>
